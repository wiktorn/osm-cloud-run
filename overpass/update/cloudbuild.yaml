steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['run', '--name', 'overpass_step1',
           '-it',
           'gcr.io/osm-vink/overpass-poland:latest',
           '/bin/bash -c "/app/bin/update_overpass.sh && /app/bin/osm3s_query --progress --rules  < /db/db/rules/areas.osm3s"',
    ]

  - name: 'gcr.io/cloud-builders/docker'
    args: ['commit',
           '-r', 'CMD /app/docker-entrypoint.sh',
           'overpass_step1', 'gcr.io/osm-vink/overpass-poland:latest',
    ]

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/osm-vink/overpass-poland:latest']

  - name: 'gcr.io/cloud-builders/gcloud'
    args: ['beta', 'run', 'deploy', 'overpass-poland',
           '--image=gcr.io/osm-vink/overpass-poland:latest',
           '--region=us-central1',
           '--memory=1024Mi',
           '--allow-unauthenticated',
    ]

timeout: 600s